<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CasesDash v3.0.0</title>

  <!-- Material Design Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">

  <!-- Inline CSS -->
  <?!= include('frontend/css/main.css'); ?>
</head>
<body>
  <? if (mode === 'login') { ?>
    <!-- Login Page -->
    <div id="loginPage" class="login-page">
      <div class="login-container">
        <div class="login-header">
          <span class="material-icons login-icon">dashboard</span>
          <h1>CasesDash</h1>
          <p class="version">v3.0.0 - IRT Support</p>
        </div>

        <div class="login-content">
          <p class="login-description">Multi-Sheet Case Management System</p>
          <p class="login-domain">@google.com accounts only</p>

          <button id="loginButton" class="btn-primary" onclick="handleLogin()">
            <span class="material-icons">login</span>
            Login with Google
          </button>

          <div id="loginError" class="error-message" style="display: none;"></div>
          <div id="loginLoading" class="loading" style="display: none;">
            <span class="spinner"></span>
            <span>Authenticating...</span>
          </div>
        </div>

        <div class="login-footer">
          <p>¬© 2025 Google Ads Support Team</p>
        </div>
      </div>
    </div>
  <? } else { ?>
    <!-- Main Application -->
    <div id="app" class="app">
      <!-- Navigation Bar -->
      <nav class="navbar">
        <div class="nav-left">
          <span class="material-icons nav-icon">dashboard</span>
          <span class="nav-title">CasesDash v3.0.0</span>
          <div class="nav-links">
            <button id="navDashboard" class="nav-link active" onclick="showScreen('dashboard')">
              <span class="material-icons">home</span>
              Dashboard
            </button>
            <button id="navMyCases" class="nav-link" onclick="showScreen('myCases')">
              <span class="material-icons">folder</span>
              My Cases
            </button>
            <button id="navCreateCase" class="nav-link" onclick="showScreen('createCase')">
              <span class="material-icons">add_circle</span>
              Create Case
            </button>
            <button id="navSettings" class="nav-link" onclick="showScreen('settings')">
              <span class="material-icons">settings</span>
              Settings
            </button>
          </div>
        </div>

        <div class="nav-right">
          <span class="user-info">
            <span class="material-icons">account_circle</span>
            <span id="userEmail"><? if (user) { ?><?= user.email ?><? } ?></span>
          </span>
          <button id="logoutButton" class="btn-text" onclick="handleLogout()">
            <span class="material-icons">logout</span>
            Logout
          </button>
        </div>
      </nav>

      <!-- Main Content -->
      <main class="main-content">
        <!-- Dashboard Screen -->
        <div id="dashboard-screen" class="screen active">
          <h1>Welcome to CasesDash</h1>
          <p>Multi-Sheet Case Management System with IRT Support</p>

          <div class="info-card">
            <h3>üéØ System Status</h3>
            <ul id="systemStatus">
              <li>‚úÖ Authentication: Active</li>
              <li>‚úÖ Session: Valid</li>
              <li id="spreadsheetStatus">‚è≥ Spreadsheet Connection: Checking...</li>
            </ul>
          </div>

          <div class="info-card">
            <h3>üìã Next Steps</h3>
            <ol>
              <li>Configure spreadsheet connection in Settings</li>
              <li>Test connection with your 6 case sheets</li>
              <li>Start managing cases with IRT tracking</li>
            </ol>
          </div>

          <div class="user-info-card">
            <h3>üë§ Current User</h3>
            <p><strong>Email:</strong> <span id="currentUserEmail"><? if (user) { ?><?= user.email ?><? } ?></span></p>
            <p><strong>LDAP:</strong> <span id="currentUserLdap"><? if (user) { ?><?= user.ldap ?><? } ?></span></p>
            <p><strong>Domain:</strong> <span id="currentUserDomain"><? if (user) { ?><?= user.domain ?><? } ?></span></p>
          </div>
        </div>

        <!-- Settings Screen -->
        <div id="settings-screen" class="screen" style="display: none;">
          <h1>Settings</h1>
          <p>Configure your CasesDash application</p>

          <div class="settings-card">
            <h2>üìä Spreadsheet Connection</h2>
            <p>Connect to your Google Spreadsheet with 6 case management sheets</p>

            <div class="form-group">
              <label for="spreadsheetId">Spreadsheet ID</label>
              <input
                type="text"
                id="spreadsheetId"
                class="form-input"
                placeholder="Enter spreadsheet ID (e.g., 1a2b3c4d5e...)"
              />
              <p class="help-text">
                Find the ID in your spreadsheet URL:
                <code>https://docs.google.com/spreadsheets/d/<strong>SPREADSHEET_ID</strong>/edit</code>
              </p>
            </div>

            <div class="button-group">
              <button id="testConnectionBtn" class="btn-secondary" onclick="testConnection()">
                <span class="material-icons">link</span>
                Test Connection
              </button>
              <button id="saveSpreadsheetBtn" class="btn-primary" onclick="saveSpreadsheetConfig()">
                <span class="material-icons">save</span>
                Save Configuration
              </button>
            </div>

            <div id="missingSheets" class="warning-card" style="display: none;">
              <h3>‚ö†Ô∏è Missing Required Sheets</h3>
              <p id="missingSheetsList"></p>
              <button id="setupSheetsBtn" class="btn-primary" onclick="setupMissingSheets()">
                <span class="material-icons">auto_fix_high</span>
                Auto-Setup Missing Sheets
              </button>
            </div>

            <div id="settingsError" class="error-message" style="display: none;"></div>
            <div id="settingsSuccess" class="success-message" style="display: none;"></div>
            <div id="settingsLoading" class="loading" style="display: none;">
              <span class="spinner"></span>
              <span>Processing...</span>
            </div>
          </div>

          <div id="connectionStatus" class="settings-card" style="display: none;">
            <h2>Connection Status</h2>
            <div id="connectionDetails"></div>
          </div>
        </div>

        <!-- My Cases Screen -->
        <div id="myCases-screen" class="screen" style="display: none;">
          <h1>üìã My Active Cases</h1>
          <p>View and manage your assigned cases with real-time IRT tracking</p>

          <div id="myCasesError" class="error-message" style="display: none;"></div>
          <div id="myCasesLoading" class="loading" style="display: none;">
            <span class="spinner"></span>
            <span>Loading cases...</span>
          </div>

          <!-- Summary Statistics -->
          <div class="cases-summary-card">
            <h3>üìä Summary</h3>
            <div id="myCasesSummary" class="cases-summary">
              <!-- Populated by JavaScript -->
            </div>
          </div>

          <!-- Cases Container -->
          <div id="myCasesContainer" class="cases-container">
            <!-- Case cards populated by JavaScript -->
          </div>
        </div>

        <!-- Create Case Screen -->
        <div id="createCase-screen" class="screen" style="display: none;">
          <h1>Create Case</h1>
          <p>Create a new case in any of the 6 sheets</p>

          <form id="createCaseForm" class="case-form" onsubmit="handleCreateCase(event); return false;">
            <!-- Sheet Selection -->
            <div class="form-group">
              <label for="sheetName">Target Sheet *</label>
              <select id="sheetName" class="form-input" required onchange="handleSheetChange()">
                <option value="">Select Sheet...</option>
                <option value="OT Email">OT Email</option>
                <option value="3PO Email">3PO Email</option>
                <option value="OT Chat">OT Chat</option>
                <option value="3PO Chat">3PO Chat</option>
                <option value="OT Phone">OT Phone</option>
                <option value="3PO Phone">3PO Phone</option>
              </select>
            </div>

            <!-- Case ID and Case Status -->
            <div class="form-row">
              <div class="form-group">
                <label for="caseId">Case ID *</label>
                <input type="text" id="caseId" class="form-input" placeholder="X-XXXXXXXXXXXXX (auto-generated if empty)" pattern="^\d-\d{13}$" title="Format: X-XXXXXXXXXXXXX (1 digit, dash, 13 digits)">
              </div>
              <div class="form-group">
                <label for="caseStatus">Case Status *</label>
                <select id="caseStatus" class="form-input" required>
                  <option value="Assigned">Assigned</option>
                  <option value="Solution Offered">Solution Offered</option>
                  <option value="Finished">Finished</option>
                </select>
              </div>
            </div>

            <!-- Date and Time -->
            <div class="form-row">
              <div class="form-group">
                <label for="caseOpenDate">Case Open Date *</label>
                <input type="date" id="caseOpenDate" class="form-input" required title="Format: YYYY-MM-DD or use date picker">
              </div>
              <div class="form-group">
                <label for="caseOpenTime">Case Open Time *</label>
                <input type="text" id="caseOpenTime" class="form-input" required placeholder="HH:MM:SS" pattern="^([01]\d|2[0-3]):([0-5]\d):([0-5]\d)$" title="Format: HH:MM:SS (e.g., 14:30:45). Use Ctrl+Shift+; for current time">
              </div>
            </div>

            <!-- Segments -->
            <div class="form-row">
              <div class="form-group">
                <label for="incomingSegment">Incoming Segment *</label>
                <select id="incomingSegment" class="form-input" required onchange="handleSegmentChange()">
                  <option value="">Select Segment...</option>
                  <option value="Platinum">Platinum</option>
                  <option value="Titanium">Titanium</option>
                  <option value="Gold" selected>Gold</option>
                  <option value="Silver">Silver</option>
                  <option value="Bronze - Low">Bronze - Low</option>
                  <option value="Bronze - High">Bronze - High</option>
                </select>
              </div>
              <div class="form-group">
                <label for="finalSegment">Final Segment *</label>
                <select id="finalSegment" class="form-input" required>
                  <option value="">Select Segment...</option>
                  <option value="Platinum">Platinum</option>
                  <option value="Titanium">Titanium</option>
                  <option value="Gold" selected>Gold</option>
                  <option value="Silver">Silver</option>
                  <option value="Bronze - Low">Bronze - Low</option>
                  <option value="Bronze - High">Bronze - High</option>
                </select>
              </div>
            </div>

            <!-- Product Category -->
            <div class="form-group">
              <label for="productCategory">Product Category *</label>
              <select id="productCategory" class="form-input" required onchange="handleProductCategoryChange()">
                <option value="">Select Category...</option>
                <option value="Search">Search</option>
                <option value="Display">Display</option>
                <option value="Video">Video</option>
                <option value="Commerce">Commerce</option>
                <option value="Apps">Apps</option>
                <option value="M&A">M&A</option>
                <option value="Policy">Policy</option>
                <option value="Billing">Billing</option>
                <option value="Other">Other</option>
              </select>
            </div>

            <!-- Sub Category (OT sheets only) -->
            <div id="subCategoryGroup" class="form-group" style="display: none;">
              <label for="subCategory">Sub Category *</label>
              <select id="subCategory" class="form-input" onchange="handleSubCategoryChange()">
                <option value="">Select Sub Category...</option>
                <option value="Search">Search</option>
                <option value="P-MAX">P-MAX</option>
                <option value="Display">Display</option>
                <option value="Demand Gen">Demand Gen</option>
                <option value="Video">Video</option>
                <option value="Apps">Apps</option>
                <option value="M&A">M&A</option>
                <option value="Other">Other</option>
              </select>
            </div>

            <!-- Issue Category (OT sheets: dynamic based on Sub Category, 3PO sheets: static list) -->
            <div class="form-group">
              <label for="issueCategory">Issue Category *</label>
              <select id="issueCategory" class="form-input" required>
                <option value="">Select Issue Category...</option>
              </select>
            </div>

            <!-- Details (3PO sheets only) -->
            <div id="detailsGroup" class="form-group" style="display: none;">
              <label for="detailsSearch">Details</label>
              <input type="text" id="detailsSearch" class="form-input" placeholder="Search or select details..." autocomplete="off">
              <select id="details" class="form-input" size="6" style="display: none;">
                <option value="">Select Details...</option>
              </select>
            </div>

            <!-- Flags -->
            <div class="form-group-checkboxes">
              <label class="checkbox-label">
                <input type="checkbox" id="triage">
                Triage
              </label>
              <label id="amInitiatedGroup" class="checkbox-label" style="display: none;">
                <input type="checkbox" id="amInitiated">
                AM Initiated
              </label>
              <label class="checkbox-label">
                <input type="checkbox" id="is30">
                Is 3.0
              </label>
              <label class="checkbox-label">
                <input type="checkbox" id="mcc">
                MCC
              </label>
              <label class="checkbox-label">
                <input type="checkbox" id="changeToChild">
                Change to Child
              </label>
              <label class="checkbox-label tooltip-container">
                <input type="checkbox" id="irtExclusion">
                IRTÈô§Â§ñÂØæË±°
                <span class="tooltip-text">
                  <strong>ÔºúIRT „ÅÆ SLA„Åã„ÇâÈô§Â§ñ„Åï„Çå„Çã„Ç±„Éº„ÇπÔºû</strong><br><br>
                  <strong>‚Ä¢ BugÔºö</strong>Case „Çí Bug „Å®„Åó„Å¶ Blocked By „Åó„Åü„ÇÇ„ÅÆ<br><br>
                  <strong>‚Ä¢ L2 ConsultÔºö</strong>„ÅÇ„Åè„Åæ„Åß„ÇÇÁßÅÈÅî„Åã„Çâ L2 „Å´ Direct „Åß‰∏ä„Åå„Å£„Åü„Ç±„Éº„Çπ„ÅÆ„Åø„ÅåÈô§Â§ñ„ÄÇ<br>
                  &nbsp;&nbsp;‰ª•‰∏ã„ÅØ IRT „ÅÆÈô§Â§ñÂØæË±°„Å´„Å™„Çä„Åæ„Åõ„Çì„ÄÇ<br>
                  &nbsp;&nbsp;- L1S/L1RÔºàL1S/L1R „Åå L2 „Å´‰∏ä„Åí„Åü„Ç±„Éº„Çπ„ÇÇÈô§Â§ñÂØæË±°„Åß„ÅØ„Å™„ÅÑÔºâ<br>
                  &nbsp;&nbsp;- pSME<br><br>
                  <strong>‚Ä¢ PayReqÔºö</strong>Payment Request ID „ÅåÁô∫Ë°å„Åï„Çå„Å¶ Blocked by „Åó„Åü„ÇÇ„ÅÆ<br><br>
                  <strong>‚Ä¢ Invoice DisputeÔºö</strong>Invoice Dispute ID „ÅåÁô∫Ë°å„Åï„Çå„Å¶ Blocked by „Åó„Åü„ÇÇ„ÅÆ<br><br>
                  <strong>‚Ä¢ WorkdriverÔºö</strong>Neo Taxnomy „ÅÆÊúÄÂæå„ÅÆ Workdriver „Çí Troubleshooting ‰ª•Â§ñ„Å´„Åó„Åü„ÇÇ„ÅÆ<br>
                  &nbsp;&nbsp;‚Äª Implementation „Å™„Å©<br><br>
                  <strong>‚Ä¢ T&S TeamÔºö</strong>T&S Team „Å´‰∏ä„Åå„Å£„Åü„Ç±„Éº„Çπ
                </span>
              </label>
            </div>

            <!-- Assignees -->
            <div class="form-row">
              <div class="form-group">
                <label for="firstAssignee">1st Assignee *</label>
                <input type="text" id="firstAssignee" class="form-input" required placeholder="Ldap (auto-filled with your LDAP)" title="Format: Ldap or Ldap@google.com">
              </div>
              <div class="form-group">
                <label for="finalAssignee">Final Assignee *</label>
                <input type="text" id="finalAssignee" class="form-input" required placeholder="Ldap (defaults to 1st Assignee)" title="Format: Ldap or Ldap@google.com">
              </div>
            </div>

            <!-- Actions -->
            <div class="form-actions">
              <button type="submit" id="createCaseBtn" class="btn-primary">
                <span class="material-icons">add</span>
                Create Case
              </button>
              <button type="button" class="btn-secondary" onclick="document.getElementById('createCaseForm').reset()">
                <span class="material-icons">clear</span>
                Clear
              </button>
            </div>

            <div id="createCaseError" class="error-message" style="display: none;"></div>
            <div id="createCaseSuccess" class="success-message" style="display: none;"></div>
            <div id="createCaseLoading" class="loading" style="display: none;">
              <span class="spinner"></span>
              <span>Creating case...</span>
            </div>
          </form>
        </div>
      </main>
    </div>
  <? } ?>

  <!-- Scripts -->
  <?!= include('frontend/js/api.js'); ?>
  <?!= include('frontend/js/auth.js'); ?>
  <?!= include('frontend/js/settings.js'); ?>
  <?!= include('frontend/js/cases.js'); ?>
  <?!= include('frontend/js/mycases.js'); ?>
</body>
</html>
