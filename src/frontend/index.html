<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CasesDash v3.0.0</title>

  <!-- Material Design Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">

  <!-- Inline CSS -->
  <?!= include('frontend/css/main.css'); ?>
</head>
<body>
  <? if (mode === 'login') { ?>
    <!-- Login Page -->
    <div id="loginPage" class="login-page">
      <div class="login-container">
        <div class="login-header">
          <span class="material-icons login-icon">dashboard</span>
          <h1>CasesDash</h1>
          <p class="version">v3.0.0 - IRT Support</p>
        </div>

        <div class="login-content">
          <p class="login-description">Multi-Sheet Case Management System</p>
          <p class="login-domain">@google.com accounts only</p>

          <button id="loginButton" class="btn-primary" onclick="handleLogin()">
            <span class="material-icons">login</span>
            Login with Google
          </button>

          <div id="loginError" class="error-message" style="display: none;"></div>
          <div id="loginLoading" class="loading" style="display: none;">
            <span class="spinner"></span>
            <span>Authenticating...</span>
          </div>
        </div>

        <div class="login-footer">
          <p>¬© 2025 Google Ads Support Team</p>
        </div>
      </div>
    </div>
  <? } else { ?>
    <!-- Main Application -->
    <div id="app" class="app">
      <!-- Navigation Bar -->
      <nav class="navbar">
        <div class="nav-left">
          <span class="material-icons nav-icon">dashboard</span>
          <span class="nav-title">CasesDash v3.0.0</span>
          <div class="nav-links">
            <button id="navDashboard" class="nav-link active" onclick="showScreen('dashboard')">
              <span class="material-icons">home</span>
              Dashboard
            </button>
            <button id="navMyCases" class="nav-link" onclick="showScreen('myCases')">
              <span class="material-icons">folder</span>
              My Cases
            </button>
            <button id="navCreateCase" class="nav-link" onclick="showScreen('createCase')">
              <span class="material-icons">add_circle</span>
              Create Case
            </button>
            <button id="navSettings" class="nav-link" onclick="showScreen('settings')">
              <span class="material-icons">settings</span>
              Settings
            </button>
          </div>
        </div>

        <div class="nav-right">
          <span class="user-info">
            <span class="material-icons">account_circle</span>
            <span id="userEmail"><? if (user) { ?><?= user.email ?><? } ?></span>
          </span>
          <button id="logoutButton" class="btn-text" onclick="handleLogout()">
            <span class="material-icons">logout</span>
            Logout
          </button>
        </div>
      </nav>

      <!-- Main Content -->
      <main class="main-content">
        <!-- Dashboard Screen -->
        <div id="dashboard-screen" class="screen active">
          <h1>üìä Dashboard</h1>
          <p>Search and manage all your cases across all statuses</p>

          <!-- Search and Filters -->
          <div class="dashboard-search-container">
            <div class="search-bar">
              <span class="material-icons">search</span>
              <input
                type="text"
                id="dashboardSearchInput"
                class="search-input"
                placeholder="Search by Case ID..."
                onkeyup="performDashboardSearch()"
              />
              <button class="clear-search-btn" onclick="clearDashboardSearch()" style="display: none;">
                <span class="material-icons">close</span>
              </button>
            </div>

            <div class="filter-controls">
              <div class="filter-group">
                <label class="filter-label">Sheet Type:</label>
                <select id="sheetTypeFilter" class="filter-select" onchange="applyDashboardFilters()">
                  <option value="all">All Sheets</option>
                  <option value="OT Email">OT Email</option>
                  <option value="3PO Email">3PO Email</option>
                  <option value="OT Chat">OT Chat</option>
                  <option value="3PO Chat">3PO Chat</option>
                  <option value="OT Phone">OT Phone</option>
                  <option value="3PO Phone">3PO Phone</option>
                </select>
              </div>

              <div class="filter-group">
                <label class="filter-label">Segment:</label>
                <select id="segmentFilter" class="filter-select" onchange="applyDashboardFilters()">
                  <option value="all">All Segments</option>
                  <option value="Platinum">Platinum</option>
                  <option value="Titanium">Titanium</option>
                  <option value="Gold">Gold</option>
                  <option value="Silver">Silver</option>
                  <option value="Bronze - Low">Bronze - Low</option>
                  <option value="Bronze - High">Bronze - High</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Case Status Tabs -->
          <div class="case-status-tabs">
            <button class="status-tab" data-status="Assigned" onclick="switchDashboardTab('Assigned')">
              <span class="material-icons">assignment</span>
              Assigned
            </button>
            <button class="status-tab" data-status="Solution Offered" onclick="switchDashboardTab('Solution Offered')">
              <span class="material-icons">mail</span>
              Solution Offered
            </button>
            <button class="status-tab" data-status="Finished" onclick="switchDashboardTab('Finished')">
              <span class="material-icons">check_circle</span>
              Finished
            </button>
            <button class="status-tab active" data-status="All" onclick="switchDashboardTab('All')">
              <span class="material-icons">view_list</span>
              All
            </button>
          </div>

          <!-- Dashboard Summary -->
          <div class="cases-summary-card">
            <div id="dashboardSummary" class="summary-stats">
              <div class="summary-stat">
                <span class="stat-label">Total Cases:</span>
                <span class="stat-value">0</span>
              </div>
            </div>
          </div>

          <!-- Error and Loading States -->
          <div id="dashboardError" class="error-message" style="display: none;"></div>
          <div id="dashboardLoading" class="loading" style="display: none;">
            <span class="spinner"></span>
            <span>Loading cases...</span>
          </div>

          <!-- Cases Container -->
          <div id="dashboardCasesContainer" class="cases-container"></div>
        </div>

        <!-- Settings Screen -->
        <div id="settings-screen" class="screen" style="display: none;">
          <h1>Settings</h1>
          <p>Configure your CasesDash application</p>

          <div class="settings-card">
            <h2>üìä Spreadsheet Connection</h2>
            <p>Connect to your Google Spreadsheet with 6 case management sheets</p>

            <div class="form-group">
              <label for="spreadsheetId">Spreadsheet ID</label>
              <input
                type="text"
                id="spreadsheetId"
                class="form-input"
                placeholder="Enter spreadsheet ID (e.g., 1a2b3c4d5e...)"
              />
              <p class="help-text">
                Find the ID in your spreadsheet URL:
                <code>https://docs.google.com/spreadsheets/d/<strong>SPREADSHEET_ID</strong>/edit</code>
              </p>
            </div>

            <div class="button-group">
              <button id="testConnectionBtn" class="btn-secondary" onclick="testConnection()">
                <span class="material-icons">link</span>
                Test Connection
              </button>
              <button id="saveSpreadsheetBtn" class="btn-primary" onclick="saveSpreadsheetConfig()">
                <span class="material-icons">save</span>
                Save Configuration
              </button>
            </div>

            <div id="missingSheets" class="warning-card" style="display: none;">
              <h3>‚ö†Ô∏è Missing Required Sheets</h3>
              <p id="missingSheetsList"></p>
              <button id="setupSheetsBtn" class="btn-primary" onclick="setupMissingSheets()">
                <span class="material-icons">auto_fix_high</span>
                Auto-Setup Missing Sheets
              </button>
            </div>

            <div id="settingsError" class="error-message" style="display: none;"></div>
            <div id="settingsSuccess" class="success-message" style="display: none;"></div>
            <div id="settingsLoading" class="loading" style="display: none;">
              <span class="spinner"></span>
              <span>Processing...</span>
            </div>
          </div>

          <div id="connectionStatus" class="settings-card" style="display: none;">
            <h2>Connection Status</h2>
            <div id="connectionDetails"></div>
          </div>
        </div>

        <!-- My Cases Screen -->
        <div id="myCases-screen" class="screen" style="display: none;">
          <h1>üìã My Active Cases</h1>
          <p>View and manage your assigned cases with real-time IRT tracking</p>

          <div id="myCasesError" class="error-message" style="display: none;"></div>
          <div id="myCasesLoading" class="loading" style="display: none;">
            <span class="spinner"></span>
            <span>Loading cases...</span>
          </div>

          <!-- Summary Statistics -->
          <div class="cases-summary-card">
            <h3>üìä Summary</h3>
            <div id="myCasesSummary" class="cases-summary">
              <!-- Populated by JavaScript -->
            </div>
          </div>

          <!-- Cases Container -->
          <div id="myCasesContainer" class="cases-container">
            <!-- Case cards populated by JavaScript -->
          </div>
        </div>

        <!-- Create Case Screen -->
        <div id="createCase-screen" class="screen" style="display: none;">
          <h1>Create Case</h1>
          <p>Create a new case in any of the 6 sheets</p>

          <form id="createCaseForm" class="case-form" onsubmit="handleCreateCase(event); return false;">
            <!-- Sheet Selection -->
            <div class="form-group">
              <label for="sheetName">Target Sheet *</label>
              <select id="sheetName" class="form-input" required onchange="handleSheetChange()">
                <option value="">Select Sheet...</option>
                <option value="OT Email">OT Email</option>
                <option value="3PO Email">3PO Email</option>
                <option value="OT Chat">OT Chat</option>
                <option value="3PO Chat">3PO Chat</option>
                <option value="OT Phone">OT Phone</option>
                <option value="3PO Phone">3PO Phone</option>
              </select>
            </div>

            <!-- Case ID and Case Status -->
            <div class="form-row">
              <div class="form-group">
                <label for="caseId">Case ID *</label>
                <input type="text" id="caseId" class="form-input" placeholder="X-XXXXXXXXXXXXX (auto-generated if empty)" pattern="^\d-\d{13}$" title="Format: X-XXXXXXXXXXXXX (1 digit, dash, 13 digits)">
              </div>
              <div class="form-group">
                <label for="caseStatus">Case Status *</label>
                <select id="caseStatus" class="form-input" required>
                  <option value="Assigned">Assigned</option>
                  <option value="Solution Offered">Solution Offered</option>
                  <option value="Finished">Finished</option>
                </select>
              </div>
            </div>

            <!-- Date and Time -->
            <div class="form-row">
              <div class="form-group">
                <label for="caseOpenDate">Case Open Date *</label>
                <input type="date" id="caseOpenDate" class="form-input" required title="Select date or use Ctrl+; for today's date">
              </div>
              <div class="form-group">
                <label for="caseOpenTime">Case Open Time *</label>
                <input type="time" id="caseOpenTime" class="form-input" required step="1" title="Select time or use Ctrl+Shift+; for current time">
              </div>
            </div>

            <!-- Segments -->
            <div class="form-row">
              <div class="form-group">
                <label for="incomingSegment">Incoming Segment *</label>
                <select id="incomingSegment" class="form-input" required onchange="handleSegmentChange()">
                  <option value="">Select Segment...</option>
                  <option value="Platinum">Platinum</option>
                  <option value="Titanium">Titanium</option>
                  <option value="Gold" selected>Gold</option>
                  <option value="Silver">Silver</option>
                  <option value="Bronze - Low">Bronze - Low</option>
                  <option value="Bronze - High">Bronze - High</option>
                </select>
              </div>
              <div class="form-group">
                <label for="finalSegment">Final Segment *</label>
                <select id="finalSegment" class="form-input" required>
                  <option value="">Select Segment...</option>
                  <option value="Platinum">Platinum</option>
                  <option value="Titanium">Titanium</option>
                  <option value="Gold" selected>Gold</option>
                  <option value="Silver">Silver</option>
                  <option value="Bronze - Low">Bronze - Low</option>
                  <option value="Bronze - High">Bronze - High</option>
                </select>
              </div>
            </div>

            <!-- Product Category -->
            <div class="form-group">
              <label for="productCategory">Product Category *</label>
              <select id="productCategory" class="form-input" required onchange="handleProductCategoryChange()">
                <option value="">Select Category...</option>
                <option value="Search">Search</option>
                <option value="Display">Display</option>
                <option value="Video">Video</option>
                <option value="Commerce">Commerce</option>
                <option value="Apps">Apps</option>
                <option value="M&A">M&A</option>
                <option value="Policy">Policy</option>
                <option value="Billing">Billing</option>
                <option value="Other">Other</option>
              </select>
            </div>

            <!-- Sub Category (OT sheets only) -->
            <div id="subCategoryGroup" class="form-group" style="display: none;">
              <label for="subCategory">Sub Category *</label>
              <select id="subCategory" class="form-input" onchange="handleSubCategoryChange()">
                <option value="">Select Sub Category...</option>
                <option value="Search">Search</option>
                <option value="P-MAX">P-MAX</option>
                <option value="Display">Display</option>
                <option value="Demand Gen">Demand Gen</option>
                <option value="Video">Video</option>
                <option value="Apps">Apps</option>
                <option value="M&A">M&A</option>
                <option value="Other">Other</option>
              </select>
            </div>

            <!-- Issue Category (OT sheets: dynamic based on Sub Category, 3PO sheets: static list) -->
            <div class="form-group">
              <label for="issueCategory">Issue Category *</label>
              <select id="issueCategory" class="form-input" required>
                <option value="">Select Issue Category...</option>
              </select>
            </div>

            <!-- Details (3PO sheets only) -->
            <div id="detailsGroup" class="form-group" style="display: none;">
              <label for="detailsSearch">Details</label>
              <input type="text" id="detailsSearch" class="form-input" placeholder="Search or select details..." autocomplete="off">
              <select id="details" class="form-input" size="6" style="display: none;">
                <option value="">Select Details...</option>
              </select>
            </div>

            <!-- Flags -->
            <div class="form-group-checkboxes">
              <label class="checkbox-label">
                <input type="checkbox" id="triage">
                Triage
              </label>
              <label id="amInitiatedGroup" class="checkbox-label" style="display: none;">
                <input type="checkbox" id="amInitiated">
                AM Initiated
              </label>
              <label class="checkbox-label">
                <input type="checkbox" id="is30">
                Is 3.0
              </label>
              <label class="checkbox-label">
                <input type="checkbox" id="mcc">
                MCC
              </label>
              <label class="checkbox-label">
                <input type="checkbox" id="changeToChild">
                Change to Child
              </label>
              <label class="checkbox-label tooltip-container">
                <input type="checkbox" id="irtExclusion">
                IRTÈô§Â§ñÂØæË±°
                <span class="tooltip-text">
                  <strong>ÔºúIRT „ÅÆ SLA„Åã„ÇâÈô§Â§ñ„Åï„Çå„Çã„Ç±„Éº„ÇπÔºû</strong><br><br>
                  <strong>‚Ä¢ BugÔºö</strong>Case „Çí Bug „Å®„Åó„Å¶ Blocked By „Åó„Åü„ÇÇ„ÅÆ<br><br>
                  <strong>‚Ä¢ L2 ConsultÔºö</strong>„ÅÇ„Åè„Åæ„Åß„ÇÇÁßÅÈÅî„Åã„Çâ L2 „Å´ Direct „Åß‰∏ä„Åå„Å£„Åü„Ç±„Éº„Çπ„ÅÆ„Åø„ÅåÈô§Â§ñ„ÄÇ<br>
                  &nbsp;&nbsp;‰ª•‰∏ã„ÅØ IRT „ÅÆÈô§Â§ñÂØæË±°„Å´„Å™„Çä„Åæ„Åõ„Çì„ÄÇ<br>
                  &nbsp;&nbsp;- L1S/L1RÔºàL1S/L1R „Åå L2 „Å´‰∏ä„Åí„Åü„Ç±„Éº„Çπ„ÇÇÈô§Â§ñÂØæË±°„Åß„ÅØ„Å™„ÅÑÔºâ<br>
                  &nbsp;&nbsp;- pSME<br><br>
                  <strong>‚Ä¢ PayReqÔºö</strong>Payment Request ID „ÅåÁô∫Ë°å„Åï„Çå„Å¶ Blocked by „Åó„Åü„ÇÇ„ÅÆ<br><br>
                  <strong>‚Ä¢ Invoice DisputeÔºö</strong>Invoice Dispute ID „ÅåÁô∫Ë°å„Åï„Çå„Å¶ Blocked by „Åó„Åü„ÇÇ„ÅÆ<br><br>
                  <strong>‚Ä¢ WorkdriverÔºö</strong>Neo Taxnomy „ÅÆÊúÄÂæå„ÅÆ Workdriver „Çí Troubleshooting ‰ª•Â§ñ„Å´„Åó„Åü„ÇÇ„ÅÆ<br>
                  &nbsp;&nbsp;‚Äª Implementation „Å™„Å©<br><br>
                  <strong>‚Ä¢ T&S TeamÔºö</strong>T&S Team „Å´‰∏ä„Åå„Å£„Åü„Ç±„Éº„Çπ
                </span>
              </label>
            </div>

            <!-- Assignees -->
            <div class="form-row">
              <div class="form-group">
                <label for="firstAssignee">1st Assignee *</label>
                <input type="text" id="firstAssignee" class="form-input" required placeholder="Ldap (auto-filled with your LDAP)" title="Format: Ldap or Ldap@google.com">
              </div>
              <div class="form-group">
                <label for="finalAssignee">Final Assignee *</label>
                <input type="text" id="finalAssignee" class="form-input" required placeholder="Ldap (defaults to 1st Assignee)" title="Format: Ldap or Ldap@google.com">
              </div>
            </div>

            <!-- Actions -->
            <div class="form-actions">
              <button type="submit" id="createCaseBtn" class="btn-primary">
                <span class="material-icons">add</span>
                Create Case
              </button>
              <button type="button" class="btn-secondary" onclick="document.getElementById('createCaseForm').reset()">
                <span class="material-icons">clear</span>
                Clear
              </button>
            </div>

            <div id="createCaseError" class="error-message" style="display: none;"></div>
            <div id="createCaseSuccess" class="success-message" style="display: none;"></div>
            <div id="createCaseLoading" class="loading" style="display: none;">
              <span class="spinner"></span>
              <span>Creating case...</span>
            </div>
          </form>
        </div>
      </main>

      <!-- Case Details Modal -->
      <div id="caseDetailsModal" class="modal" style="display: none;" role="dialog" aria-modal="true" aria-labelledby="caseDetailsModalTitle">
        <div class="modal-overlay" onclick="closeCaseDetailsModal()"></div>
        <div class="modal-dialog">
          <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header">
              <h2 id="caseDetailsModalTitle" class="modal-title">
                <span class="material-icons">description</span>
                Case Details
              </h2>
              <button class="modal-close-btn" onclick="closeCaseDetailsModal()" aria-label="Close modal" title="Close (Esc)">
                <span class="material-icons">close</span>
              </button>
            </div>

            <!-- Modal Body -->
            <div class="modal-body" id="caseDetailsContent">
              <!-- Loading State -->
              <div id="caseDetailsLoading" class="modal-loading">
                <span class="spinner"></span>
                <span>Loading case details...</span>
              </div>

              <!-- Error State -->
              <div id="caseDetailsError" class="error-message" style="display: none;"></div>

              <!-- Case Details Content -->
              <div id="caseDetailsData" style="display: none;">
                <!-- Basic Information Section -->
                <section class="details-section">
                  <h3 class="details-section-title">
                    <span class="material-icons">info</span>
                    Basic Information
                  </h3>
                  <div class="details-grid">
                    <div class="detail-item">
                      <span class="detail-label">Case ID</span>
                      <span class="detail-value" id="detailCaseId"></span>
                    </div>
                    <div class="detail-item">
                      <span class="detail-label">Sheet</span>
                      <span class="detail-value" id="detailSheet"></span>
                    </div>
                    <div class="detail-item">
                      <span class="detail-label">Status</span>
                      <span class="detail-value status-badge" id="detailStatus"></span>
                    </div>
                    <div class="detail-item">
                      <span class="detail-label">Case Opened</span>
                      <span class="detail-value" id="detailCaseOpened"></span>
                    </div>
                  </div>
                </section>

                <!-- Product & Category Section -->
                <section class="details-section">
                  <h3 class="details-section-title">
                    <span class="material-icons">category</span>
                    Product & Category
                  </h3>
                  <div class="details-grid">
                    <div class="detail-item">
                      <span class="detail-label">Product Category</span>
                      <span class="detail-value" id="detailProductCategory"></span>
                    </div>
                    <div class="detail-item" id="detailSubCategoryItem" style="display: none;">
                      <span class="detail-label">Sub Category</span>
                      <span class="detail-value" id="detailSubCategory"></span>
                    </div>
                    <div class="detail-item">
                      <span class="detail-label">Issue Category</span>
                      <span class="detail-value" id="detailIssueCategory"></span>
                    </div>
                    <div class="detail-item" id="detailDetailsItem" style="display: none;">
                      <span class="detail-label">Details</span>
                      <span class="detail-value" id="detailDetails"></span>
                    </div>
                  </div>
                </section>

                <!-- Segment & Assignee Section -->
                <section class="details-section">
                  <h3 class="details-section-title">
                    <span class="material-icons">people</span>
                    Segment & Assignee
                  </h3>
                  <div class="details-grid">
                    <div class="detail-item">
                      <span class="detail-label">Incoming Segment</span>
                      <span class="detail-value segment-badge" id="detailIncomingSegment"></span>
                    </div>
                    <div class="detail-item">
                      <span class="detail-label">Final Segment</span>
                      <span class="detail-value segment-badge" id="detailFinalSegment"></span>
                    </div>
                    <div class="detail-item">
                      <span class="detail-label">1st Assignee</span>
                      <span class="detail-value" id="detailFirstAssignee"></span>
                    </div>
                    <div class="detail-item">
                      <span class="detail-label">Final Assignee</span>
                      <span class="detail-value" id="detailFinalAssignee"></span>
                    </div>
                  </div>
                </section>

                <!-- IRT Information Section -->
                <section class="details-section">
                  <h3 class="details-section-title">
                    <span class="material-icons">schedule</span>
                    IRT Information
                  </h3>
                  <div class="details-grid">
                    <div class="detail-item">
                      <span class="detail-label">IRT Hours</span>
                      <span class="detail-value" id="detailIRTHours"></span>
                    </div>
                    <div class="detail-item">
                      <span class="detail-label">IRT Remaining</span>
                      <span class="detail-value" id="detailIRTRemaining"></span>
                    </div>
                    <div class="detail-item">
                      <span class="detail-label">ReOpen Count</span>
                      <span class="detail-value" id="detailReopenCount"></span>
                    </div>
                    <div class="detail-item">
                      <span class="detail-label">SO Period Hours</span>
                      <span class="detail-value" id="detailSOPeriod"></span>
                    </div>
                  </div>
                </section>

                <!-- Flags Section -->
                <section class="details-section">
                  <h3 class="details-section-title">
                    <span class="material-icons">flag</span>
                    Flags & Options
                  </h3>
                  <div class="details-flags" id="detailFlags">
                    <!-- Flags populated by JavaScript -->
                  </div>
                </section>

                <!-- Additional Info Section -->
                <section class="details-section" id="detailAdditionalSection" style="display: none;">
                  <h3 class="details-section-title">
                    <span class="material-icons">more_horiz</span>
                    Additional Information
                  </h3>
                  <div class="details-grid" id="detailAdditional">
                    <!-- Additional info populated by JavaScript -->
                  </div>
                </section>
              </div>
            </div>

            <!-- Modal Footer -->
            <div class="modal-footer">
              <button class="btn-secondary" onclick="closeCaseDetailsModal()">
                <span class="material-icons">close</span>
                Close
              </button>
              <button id="reopenCaseBtn" class="btn-secondary" onclick="reopenCaseFromModal()" style="display: none;">
                <span class="material-icons">refresh</span>
                ReOpen Case
              </button>
              <button class="btn-primary" onclick="editCaseFromModal()">
                <span class="material-icons">edit</span>
                Edit Case
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Case Modal -->
    <div id="editCaseModal" class="modal" style="display: none;" role="dialog" aria-modal="true" aria-labelledby="editCaseModalTitle">
      <div class="modal-overlay" onclick="closeEditCaseModal()"></div>
      <div class="modal-dialog">
        <div class="modal-content">
          <!-- Modal Header -->
          <div class="modal-header">
            <h2 id="editCaseModalTitle" class="modal-title">
              <span class="material-icons">edit</span>
              Edit Case
            </h2>
            <button class="modal-close-btn" onclick="closeEditCaseModal()" aria-label="Close modal">
              <span class="material-icons">close</span>
            </button>
          </div>

          <!-- Modal Body -->
          <div class="modal-body" id="editCaseContent">
            <!-- Loading State -->
            <div id="editCaseLoading" class="modal-loading" style="display: flex;">
              <div class="spinner"></div>
              <p>Loading case data...</p>
            </div>

            <!-- Error State -->
            <div id="editCaseError" class="modal-error" style="display: none;">
              Error loading case data
            </div>

            <!-- Edit Form -->
            <form id="editCaseForm" style="display: none;">
              <!-- Read-Only Context Section -->
              <section class="details-section">
                <h3 class="section-title">
                  <span class="material-icons">info</span>
                  Case Information
                </h3>
                <div class="details-grid">
                  <div class="detail-item">
                    <span class="detail-label">Case ID</span>
                    <span class="detail-value" id="editCaseId">-</span>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">Sheet</span>
                    <span class="detail-value" id="editSheet">-</span>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">Case Opened</span>
                    <span class="detail-value" id="editCaseOpened">-</span>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">1st Assignee</span>
                    <span class="detail-value" id="editFirstAssignee">-</span>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">Incoming Segment</span>
                    <span class="detail-value segment-badge" id="editIncomingSegment" data-segment="">-</span>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">Product Category</span>
                    <span class="detail-value" id="editProductCategory">-</span>
                  </div>
                </div>
              </section>

              <!-- Status & Assignment Section (Editable) -->
              <section class="details-section">
                <h3 class="section-title">
                  <span class="material-icons">assignment</span>
                  Status & Assignment
                </h3>
                <div class="form-grid">
                  <div class="form-group">
                    <label for="inputCaseStatus" class="form-label">
                      Case Status <span class="required">*</span>
                    </label>
                    <select id="inputCaseStatus" class="form-control" required>
                      <option value="Assigned">Assigned</option>
                      <option value="Solution Offered">Solution Offered</option>
                      <option value="Finished">Finished</option>
                    </select>
                  </div>

                  <div class="form-group">
                    <label for="inputFinalAssignee" class="form-label">
                      Final Assignee (LDAP) <span class="required">*</span>
                    </label>
                    <input
                      type="text"
                      id="inputFinalAssignee"
                      class="form-control"
                      placeholder="e.g., jsmith"
                      required
                    />
                    <small class="form-hint">LDAP ID without @google.com</small>
                  </div>

                  <div class="form-group">
                    <label for="inputFinalSegment" class="form-label">
                      Final Segment <span class="required">*</span>
                    </label>
                    <select id="inputFinalSegment" class="form-control" required>
                      <option value="Platinum">Platinum</option>
                      <option value="Titanium">Titanium</option>
                      <option value="Gold">Gold</option>
                      <option value="Silver">Silver</option>
                      <option value="Bronze - Low">Bronze - Low</option>
                      <option value="Bronze - High">Bronze - High</option>
                    </select>
                  </div>
                </div>
              </section>

              <!-- Close Date/Time Section (Editable) -->
              <section class="details-section" id="closeDateTimeSection">
                <h3 class="section-title">
                  <span class="material-icons">event_available</span>
                  <span id="closeDateTimeTitle">Close Date & Time</span>
                </h3>
                <div class="form-grid">
                  <div class="form-group">
                    <label for="inputCloseDate" class="form-label">
                      <span id="closeDateLabel">Close Date</span>
                    </label>
                    <input
                      type="date"
                      id="inputCloseDate"
                      class="form-control"
                      placeholder="YYYY-MM-DD"
                    />
                    <small class="form-hint">Date when case was closed (YYYY-MM-DD)</small>
                  </div>

                  <div class="form-group">
                    <label for="inputCloseTime" class="form-label">
                      <span id="closeTimeLabel">Close Time</span>
                    </label>
                    <input
                      type="time"
                      id="inputCloseTime"
                      class="form-control"
                      step="1"
                      placeholder="HH:MM:SS"
                    />
                    <small class="form-hint">Time when case was closed (HH:MM:SS)</small>
                  </div>
                </div>
              </section>

              <!-- Flags Section (Editable) -->
              <section class="details-section">
                <h3 class="section-title">
                  <span class="material-icons">flag</span>
                  Case Flags
                </h3>
                <div class="form-checkboxes">
                  <div class="form-checkbox">
                    <input type="checkbox" id="inputTriage" />
                    <label for="inputTriage">
                      <span class="material-icons">filter_list</span>
                      Triage
                    </label>
                  </div>

                  <div class="form-checkbox" id="amInitiatedCheckbox">
                    <input type="checkbox" id="inputAmInitiated" />
                    <label for="inputAmInitiated">
                      <span class="material-icons">contact_mail</span>
                      AM Initiated
                    </label>
                  </div>

                  <div class="form-checkbox">
                    <input type="checkbox" id="inputIs30" />
                    <label for="inputIs30">
                      <span class="material-icons">new_releases</span>
                      Is 3.0
                    </label>
                  </div>

                  <div class="form-checkbox">
                    <input type="checkbox" id="inputMcc" />
                    <label for="inputMcc">
                      <span class="material-icons">account_tree</span>
                      MCC
                    </label>
                  </div>

                  <div class="form-checkbox">
                    <input type="checkbox" id="inputChangeToChild" />
                    <label for="inputChangeToChild">
                      <span class="material-icons">child_care</span>
                      Change to Child
                    </label>
                  </div>

                  <div class="form-checkbox tooltip-container">
                    <input type="checkbox" id="inputBugL2" />
                    <label for="inputBugL2">
                      <span class="material-icons">bug_report</span>
                      IRTÈô§Â§ñÂØæË±°
                    </label>
                    <span class="tooltip-text">
                      <strong>ÔºúIRT „ÅÆ SLA„Åã„ÇâÈô§Â§ñ„Åï„Çå„Çã„Ç±„Éº„ÇπÔºû</strong><br><br>
                      <strong>‚Ä¢ BugÔºö</strong>Case „Çí Bug „Å®„Åó„Å¶ Blocked By „Åó„Åü„ÇÇ„ÅÆ<br><br>
                      <strong>‚Ä¢ L2 ConsultÔºö</strong>„ÅÇ„Åè„Åæ„Åß„ÇÇÁßÅÈÅî„Åã„Çâ L2 „Å´ Direct „Åß‰∏ä„Åå„Å£„Åü„Ç±„Éº„Çπ„ÅÆ„Åø„ÅåÈô§Â§ñ„ÄÇ<br>
                      &nbsp;&nbsp;‰ª•‰∏ã„ÅØ IRT „ÅÆÈô§Â§ñÂØæË±°„Å´„Å™„Çä„Åæ„Åõ„Çì„ÄÇ<br>
                      &nbsp;&nbsp;- L1S/L1RÔºàL1S/L1R „Åå L2 „Å´‰∏ä„Åí„Åü„Ç±„Éº„Çπ„ÇÇÈô§Â§ñÂØæË±°„Åß„ÅØ„Å™„ÅÑÔºâ<br>
                      &nbsp;&nbsp;- pSME<br><br>
                      <strong>‚Ä¢ PayReqÔºö</strong>Payment Request ID „ÅåÁô∫Ë°å„Åï„Çå„Å¶ Blocked by „Åó„Åü„ÇÇ„ÅÆ<br><br>
                      <strong>‚Ä¢ Invoice DisputeÔºö</strong>Invoice Dispute ID „ÅåÁô∫Ë°å„Åï„Çå„Å¶ Blocked by „Åó„Åü„ÇÇ„ÅÆ<br><br>
                      <strong>‚Ä¢ WorkdriverÔºö</strong>Neo Taxnomy „ÅÆÊúÄÂæå„ÅÆ Workdriver „Çí Troubleshooting ‰ª•Â§ñ„Å´„Åó„Åü„ÇÇ„ÅÆ<br>
                      &nbsp;&nbsp;‚Äª Implementation „Å™„Å©<br><br>
                      <strong>‚Ä¢ T&S TeamÔºö</strong>T&S Team „Å´‰∏ä„Åå„Å£„Åü„Ç±„Éº„Çπ
                    </span>
                  </div>
                </div>
              </section>

              <!-- Transfer Fields Section (Editable) -->
              <section class="details-section">
                <h3 class="section-title">
                  <span class="material-icons">swap_horiz</span>
                  Transfer & Disposition
                </h3>
                <div class="form-grid">
                  <div class="form-group">
                    <label for="inputAmTransfer" class="form-label">
                      AM Transfer
                    </label>
                    <select id="inputAmTransfer" class="form-control">
                      <option value="">None</option>
                      <option value="Request to AM contact">Request to AM contact</option>
                      <option value="Optimize request">Optimize request</option>
                      <option value="Œ≤ product inquiry">Œ≤ product inquiry</option>
                      <option value="Trouble shooting scope but we don't have access to the resource">Trouble shooting scope but we don't have access to the resource</option>
                      <option value="Tag team request (LCS customer)">Tag team request (LCS customer)</option>
                      <option value="Data analysis">Data analysis</option>
                      <option value="Allowlist request">Allowlist request</option>
                      <option value="Other">Other</option>
                    </select>
                  </div>

                  <div class="form-group">
                    <label for="inputNonNcc" class="form-label">
                      non NCC
                    </label>
                    <select id="inputNonNcc" class="form-control">
                      <option value="">None</option>
                      <option value="Duplicate">Duplicate</option>
                      <option value="Discard">Discard</option>
                      <option value="Transfer to Platinum">Transfer to Platinum</option>
                      <option value="Transfer to S/B">Transfer to S/B</option>
                      <option value="Transfer to TDCX">Transfer to TDCX</option>
                      <option value="Transfer to 3PO">Transfer to 3PO</option>
                      <option value="Transfer to OT">Transfer to OT</option>
                      <option value="Transfer to EN Team">Transfer to EN Team</option>
                      <option value="Transfer to GMB Team">Transfer to GMB Team</option>
                      <option value="Transfer to Other Team (not AM)">Transfer to Other Team (not AM)</option>
                    </select>
                  </div>
                </div>
              </section>
            </form>
          </div>

          <!-- Modal Footer -->
          <div class="modal-footer">
            <button type="button" class="btn-secondary" onclick="closeEditCaseModal()">
              <span class="material-icons">close</span>
              Cancel
            </button>
            <button type="button" class="btn-primary" onclick="saveEditCase()" id="saveEditBtn">
              <span class="material-icons">save</span>
              Save Changes
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ReOpen Case Modal -->
    <div id="reopenCaseModal" class="modal" style="display: none;" role="dialog" aria-modal="true" aria-labelledby="reopenCaseModalTitle">
      <div class="modal-overlay" onclick="closeReopenCaseModal()"></div>
      <div class="modal-dialog" style="max-width: 500px;">
        <div class="modal-content">
          <!-- Modal Header -->
          <div class="modal-header">
            <h2 id="reopenCaseModalTitle" class="modal-title">
              <span class="material-icons">refresh</span>
              ReOpen Case
            </h2>
            <button class="modal-close-btn" onclick="closeReopenCaseModal()" aria-label="Close modal">
              <span class="material-icons">close</span>
            </button>
          </div>

          <!-- Modal Body -->
          <div class="modal-body">
            <div class="details-section">
              <h3 class="section-title">
                <span class="material-icons">info</span>
                Case Information
              </h3>
              <div class="details-grid">
                <div class="detail-item">
                  <span class="detail-label">Case ID</span>
                  <span class="detail-value" id="reopenCaseId">-</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Current Status</span>
                  <span class="detail-value" id="reopenCurrentStatus">-</span>
                </div>
              </div>
            </div>

            <div class="details-section">
              <h3 class="section-title">
                <span class="material-icons">event</span>
                ReOpen Date and Time
              </h3>
              <div class="form-grid">
                <div class="form-group">
                  <label for="reopenDate" class="form-label">ReOpen Date *</label>
                  <input type="date" id="reopenDate" class="form-input" required
                         title="Select ReOpen date">
                </div>
                <div class="form-group">
                  <label for="reopenTime" class="form-label">ReOpen Time *</label>
                  <input type="time" id="reopenTime" class="form-input" required step="1"
                         title="Select ReOpen time">
                </div>
              </div>
            </div>
          </div>

          <!-- Modal Footer -->
          <div class="modal-footer">
            <button type="button" class="btn-secondary" onclick="closeReopenCaseModal()">
              <span class="material-icons">close</span>
              Cancel
            </button>
            <button type="button" class="btn-primary" onclick="confirmReopenCase()" id="confirmReopenBtn">
              <span class="material-icons">refresh</span>
              Confirm ReOpen
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ReOpen ATTENTION Modal -->
    <div id="reopenAttentionModal" class="modal" style="display: none;" role="dialog" aria-modal="true" aria-labelledby="reopenAttentionModalTitle">
      <div class="modal-overlay" onclick="closeReopenAttentionModal()"></div>
      <div class="modal-dialog" style="max-width: 600px;">
        <div class="modal-content">
          <!-- Modal Header -->
          <div class="modal-header" style="background-color: #fbbc04; color: #202124;">
            <h2 id="reopenAttentionModalTitle" class="modal-title">
              <span class="material-icons" style="color: #202124;">warning</span>
              ATTENTION
            </h2>
            <button class="modal-close-btn" onclick="closeReopenAttentionModal()" aria-label="Close modal" style="color: #202124;">
              <span class="material-icons">close</span>
            </button>
          </div>

          <!-- Modal Body -->
          <div class="modal-body" style="padding: 24px;">
            <p style="margin-bottom: 16px; font-weight: 500;">Reopen „Åó„ÅüÂæå„ÄÅ‰ª•‰∏ã 4 „Å§„ÅÆ„Ç¢„ÇØ„Ç∑„Éß„É≥„ÇíË°å„ÅÜ„Å®„ÄÅClose ÊôÇÈñì„ÅåÊõ¥Êñ∞„Åï„Çå„Åæ„Åô</p>

            <ul style="margin-left: 20px; margin-bottom: 16px; line-height: 1.8;">
              <li>Case Status „Çí Solution Offered „Å´Â§âÊõ¥</li>
              <li>RB</li>
              <li>Phone Note „Çí‰øùÂ≠ò</li>
              <li>Email ÈÄÅ‰ø°</li>
            </ul>

            <p style="margin-bottom: 16px; font-weight: 500; color: #ea4335;">
              Reopen Âæå„Å´ IRT Missed „Åó„Åü„Ç±„Éº„Çπ„Åß„ÄÅ‰∏äË®ò 4 „Å§„ÅÆ„ÅÑ„Åö„Çå„Åã„ÅÆ„Ç¢„ÇØ„Ç∑„Éß„É≥„ÅåÂøÖË¶Å„Å®„Å™„Å£„ÅüÂ†¥Âêà„ÄÅ‰∫ãÂâç„Å´ JTL / TL „Å∏Áõ∏Ë´á„Åó„Åæ„Åó„Çá„ÅÜ
            </p>

            <div style="background-color: #f8f9fa; padding: 16px; border-radius: 8px; border-left: 4px solid #1a73e8;">
              <p style="margin-bottom: 8px; font-weight: 600;">„Äê in-IRT / IRT Missed „ÅÆ‰∏Ä‰æã„Äë</p>
              <p style="margin-bottom: 8px;"><strong>Reopen Âæå„Å´ IRT Missed „Åó„ÅüÂ†¥Âêà:</strong></p>
              <ul style="margin-left: 20px; line-height: 1.8;">
                <li><strong>in-IRT Êâ±„ÅÑ:</strong> ‰Ωï„ÇÇ„Åõ„Åö„Åù„ÅÆ„Åæ„Åæ Finished Close „Åó„Åü<br>
                    <span style="color: #5f6368;">(‰æã: „Çµ„É≥„ÇØ„Çπ„É°„Éº„É´Âèó‰ø°Âæå„Å™„Å©)</span></li>
                <li><strong>IRT Missed Êâ±„ÅÑ:</strong> TAT Ë®≠ÂÆö„ÅÆ„É°„Éº„É´„ÇíÈÄÅ‰ø°„Åó„Åü<br>
                    <span style="color: #5f6368;">(‰æã: ËøΩÂä†Ë≥™Âïè„Åå„ÅÇ„Å£„Åü„ÅÆ„Åß„Å®„Çä„ÅÇ„Åà„Åö TAT Ë®≠ÂÆö„Åó„Åü„Åå„ÄÅProduct Scope Â§ñ„ÅÆ„Åü„ÇÅ Split „Åó„Å¶Ëª¢ÈÄÅ„Åó„Åü)</span></li>
              </ul>
            </div>
          </div>

          <!-- Modal Footer -->
          <div class="modal-footer">
            <button type="button" class="btn-secondary" onclick="closeReopenAttentionModal()" style="width: 100%; background-color: #34a853; color: white; border-color: #34a853;">
              <span class="material-icons">check</span>
              ‰∫ÜËß£„Åó„Åæ„Åó„Åü
            </button>
          </div>
        </div>
      </div>
    </div>

  <? } ?>

  <!-- Toast Notification Container -->
  <div id="toastContainer" class="toast-container"></div>

  <!-- Scripts -->
  <?!= include('frontend/js/api.js'); ?>
  <?!= include('frontend/js/auth.js'); ?>
  <?!= include('frontend/js/settings.js'); ?>
  <?!= include('frontend/js/cases.js'); ?>
  <?!= include('frontend/js/dashboard.js'); ?>
  <?!= include('frontend/js/mycases.js'); ?>
  <?!= include('frontend/js/caseDetailsModal.js'); ?>
  <?!= include('frontend/js/editCaseModal.js'); ?>
  <?!= include('frontend/js/reopenCaseModal.js'); ?>
</body>
</html>
