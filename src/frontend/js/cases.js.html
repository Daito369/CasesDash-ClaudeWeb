<script>
/**
 * Case Management
 *
 * Handles case creation, viewing, and management.
 *
 * @author CasesDash v3.0.0
 */

/**
 * Load Create Case screen
 */
async function loadCreateCaseScreen() {
  console.log('Loading Create Case screen...');

  // Skip spreadsheet connection check to avoid rate limiting
  // User will get error on submit if not configured

  // Set default values
  const now = new Date();
  const dateInput = document.getElementById('caseOpenDate');
  const timeInput = document.getElementById('caseOpenTime');

  if (dateInput) dateInput.value = formatDateForInput(now);
  if (timeInput) timeInput.value = formatTimeForInput(now);

  // Auto-fill assignees with current user's LDAP
  try {
    const user = await API.auth.getCurrentUser();
    if (user && user.email) {
      const ldap = user.email.split('@')[0];
      const firstAssigneeInput = document.getElementById('firstAssignee');
      const finalAssigneeInput = document.getElementById('finalAssignee');

      if (firstAssigneeInput && !firstAssigneeInput.value) {
        firstAssigneeInput.value = ldap;
      }
      if (finalAssigneeInput && !finalAssigneeInput.value) {
        finalAssigneeInput.value = ldap;
      }
    }
  } catch (error) {
    console.error('Error auto-filling assignees:', error);
  }

  // Auto-focus on first required field (Target Sheet)
  const sheetNameInput = document.getElementById('sheetName');
  if (sheetNameInput) {
    sheetNameInput.focus();
  }
}

/**
 * Handle case creation form submission
 */
async function handleCreateCase(event) {
  if (event) {
    event.preventDefault();
  }

  console.log('Creating case...');

  hideError('createCaseError');
  hideSuccess('createCaseSuccess');
  showLoading('createCaseLoading');

  const createBtn = document.getElementById('createCaseBtn');
  if (createBtn) createBtn.disabled = true;

  try {
    // Get form data
    const sheetName = document.getElementById('sheetName').value;
    const caseData = {
      caseId: document.getElementById('caseId').value,
      caseStatus: document.getElementById('caseStatus').value,
      caseOpenDate: document.getElementById('caseOpenDate').value,
      caseOpenTime: document.getElementById('caseOpenTime').value,
      incomingSegment: document.getElementById('incomingSegment').value,
      finalSegment: document.getElementById('finalSegment').value,
      firstAssignee: document.getElementById('firstAssignee').value,
      finalAssignee: document.getElementById('finalAssignee').value,
      productCategory: document.getElementById('productCategory').value,
      issueCategory: document.getElementById('issueCategory').value,
      triage: document.getElementById('triage').checked,
      is30: document.getElementById('is30').checked,
      mcc: document.getElementById('mcc').checked,
      changeToChild: document.getElementById('changeToChild').checked,
      bugL2: document.getElementById('bugL2').checked
    };

    // Sheet-specific fields
    if (sheetName.includes('OT') && !sheetName.includes('3PO')) {
      caseData.subCategory = document.getElementById('subCategory').value;
    }

    if (sheetName.includes('Email')) {
      caseData.amInitiated = document.getElementById('amInitiated').checked;
    }

    if (sheetName.includes('3PO')) {
      caseData.details = document.getElementById('details').value;
    }

    // Validate
    if (!sheetName) {
      showError('createCaseError', 'Please select a sheet');
      return;
    }

    if (!caseData.incomingSegment) {
      showError('createCaseError', 'Incoming Segment is required');
      return;
    }

    if (!caseData.productCategory) {
      showError('createCaseError', 'Product Category is required');
      return;
    }

    if (!caseData.issueCategory) {
      showError('createCaseError', 'Issue Category is required');
      return;
    }

    console.log('Case data:', caseData);
    console.log('Target sheet:', sheetName);

    // Create case
    const result = await API.cases.create(caseData, sheetName);

    console.log('Create case result:', result);

    // Check if result is null or undefined
    if (!result) {
      showError('createCaseError', 'Backend returned no response. Please check Apps Script logs for errors.');
      return;
    }

    if (result.success) {
      showSuccess('createCaseSuccess', `✅ Case created successfully! Case ID: ${result.caseId}`);

      // Reset form
      setTimeout(() => {
        document.getElementById('createCaseForm').reset();
        loadCreateCaseScreen();
      }, 2000);
    } else {
      showError('createCaseError', result.error || 'Failed to create case');
    }

  } catch (error) {
    console.error('Error creating case:', error);
    showError('createCaseError', handleAPIError(error, 'create case'));

  } finally {
    hideLoading('createCaseLoading');
    if (createBtn) createBtn.disabled = false;
  }
}

/**
 * Load My Cases screen
 */
async function loadMyCasesScreen() {
  console.log('Loading My Cases...');

  // Temporarily disabled to avoid rate limiting
  const container = document.getElementById('myCasesList');
  if (container) {
    container.innerHTML = '<p class="info-message">My Cases feature temporarily disabled to avoid rate limiting. Please check back later.</p>';
  }

  return;

  /* Temporarily disabled
  showLoading('myCasesLoading');
  hideError('myCasesError');

  try {
    const result = await API.cases.getMyCases({});

    console.log('My cases result:', result);

    if (result.success) {
      displayCases(result.cases, 'myCasesList');
    } else {
      showError('myCasesError', result.error || 'Failed to load cases');
    }

  } catch (error) {
    console.error('Error loading my cases:', error);
    showError('myCasesError', handleAPIError(error, 'load cases'));

  } finally {
    hideLoading('myCasesLoading');
  }
  */
}

/**
 * Display cases in list
 * @param {Array} cases - Array of case objects
 * @param {string} containerId - Container element ID
 */
function displayCases(cases, containerId) {
  const container = document.getElementById(containerId);
  if (!container) return;

  if (!cases || cases.length === 0) {
    container.innerHTML = '<p class="empty-state">No cases found</p>';
    return;
  }

  let html = '<div class="cases-grid">';

  cases.forEach(item => {
    const c = item.case;
    const irt = item.irtData;

    const urgencyClass = getUrgencyClass(irt);
    const irtRemaining = irt ? irt.irtRemainingHours.toFixed(1) : 'N/A';

    html += `
      <div class="case-card ${urgencyClass}">
        <div class="case-header">
          <span class="case-id">${c.caseId}</span>
          <span class="case-status status-${c.caseStatus.toLowerCase().replace(' ', '-')}">${c.caseStatus}</span>
        </div>
        <div class="case-body">
          <p><strong>Sheet:</strong> ${c.sourceSheet}</p>
          <p><strong>Segment:</strong> ${c.incomingSegment}</p>
          <p><strong>Category:</strong> ${c.productCategory}</p>
          <p><strong>Assignee:</strong> ${c.finalAssignee || c.firstAssignee}</p>
          <p class="case-irt"><strong>IRT Remaining:</strong> <span class="irt-value">${irtRemaining}h</span></p>
        </div>
        <div class="case-actions">
          <button class="btn-sm" onclick="viewCase('${c.caseId}')">View</button>
          <button class="btn-sm btn-secondary" onclick="updateCaseStatus('${c.caseId}')">Update</button>
        </div>
      </div>
    `;
  });

  html += '</div>';
  container.innerHTML = html;
}

/**
 * Get urgency class based on IRT
 * @param {Object} irtData - IRT data
 * @return {string} CSS class name
 */
function getUrgencyClass(irtData) {
  if (!irtData || !irtData.irtRemainingHours) return '';

  const remaining = irtData.irtRemainingHours;

  if (remaining <= 0) return 'urgency-missed';
  if (remaining <= 2) return 'urgency-critical';
  if (remaining <= 4) return 'urgency-warning';
  return 'urgency-normal';
}

/**
 * View case details
 * @param {string} caseId - Case ID
 */
async function viewCase(caseId) {
  console.log('Viewing case:', caseId);
  alert(`View case details: ${caseId}\n(Full implementation coming soon)`);
}

/**
 * Update case status
 * @param {string} caseId - Case ID
 */
async function updateCaseStatus(caseId) {
  const newStatus = prompt('Enter new status (Assigned / Solution Offered / Finished):');

  if (!newStatus) return;

  const validStatuses = ['Assigned', 'Solution Offered', 'Finished'];
  if (!validStatuses.includes(newStatus)) {
    alert('Invalid status. Must be: Assigned, Solution Offered, or Finished');
    return;
  }

  try {
    const result = await API.cases.update(caseId, { caseStatus: newStatus });

    if (result.success) {
      alert(`Case ${caseId} updated to ${newStatus}`);
      // Reload cases
      loadMyCasesScreen();
    } else {
      alert(`Failed to update case: ${result.error}`);
    }

  } catch (error) {
    alert(`Error: ${error.message}`);
  }
}

/**
 * Handle sheet selection change
 */
function handleSheetChange() {
  const sheetName = document.getElementById('sheetName').value;

  // Show/hide conditional fields
  const subCategoryGroup = document.getElementById('subCategoryGroup');
  const amInitiatedGroup = document.getElementById('amInitiatedGroup');
  const detailsGroup = document.getElementById('detailsGroup');

  // Reset visibility
  if (subCategoryGroup) subCategoryGroup.style.display = 'none';
  if (amInitiatedGroup) amInitiatedGroup.style.display = 'none';
  if (detailsGroup) detailsGroup.style.display = 'none';

  if (!sheetName) return;

  // OT sheets (not 3PO) have subCategory
  if (sheetName.includes('OT') && !sheetName.includes('3PO')) {
    if (subCategoryGroup) subCategoryGroup.style.display = 'block';
  }

  // Email sheets have amInitiated
  if (sheetName.includes('Email')) {
    if (amInitiatedGroup) amInitiatedGroup.style.display = 'block';
  }

  // 3PO sheets have details
  if (sheetName.includes('3PO')) {
    if (detailsGroup) detailsGroup.style.display = 'block';
  }
}

/**
 * Handle segment change - sync Final Segment with Incoming Segment
 */
function handleSegmentChange() {
  const incomingSegment = document.getElementById('incomingSegment').value;
  const finalSegmentSelect = document.getElementById('finalSegment');

  if (finalSegmentSelect && incomingSegment) {
    // Auto-set Final Segment to match Incoming Segment
    finalSegmentSelect.value = incomingSegment;
  }
}

/**
 * Issue Category options mapping for OT sheets (spec lines 1082-1090)
 */
const ISSUE_CATEGORY_MAP = {
  'Search': [
    'Search 仕様・機能',
    'Search レポート',
    'Search カスタムテスト・バリエーション',
    '無効なクリックの調査',
    '自動化ルール',
    'Search その他'
  ],
  'P-MAX': [
    'P-MAX 配信関連',
    'P-MAX 仕様・機能',
    'P-MAX レポート',
    'P-MAX カスタムテスト・バリエーション',
    '除外 KW 追加依頼',
    'P-MAX その他'
  ],
  'Display': [
    'Display 仕様・機能',
    'Display 配信状況',
    '動的リマーケティング広告・ビジネスデータフィード',
    '「ウェブサイトを訪れたユーザー」のデータセグメント',
    '顧客リスト',
    'データセグメントの共有',
    'シームカービングのオプトアウト',
    'Display レポート',
    'Display 3PAS 関連',
    'Display その他'
  ],
  'Demand Gen': [
    'Demand Gen 仕様・機能',
    'Demand Gen 配信関連',
    'オーディエンス',
    'BLS',
    'Demand Gen レポート',
    'Demand Gen 3PAS 関連',
    'Demand Gen その他'
  ],
  'Video': [
    'Video 仕様・機能',
    'Video 配信状況',
    'YouTube ユーザーセグメント',
    'BLS (ブランドリフト調査)/SLS (検索数の増加測定)',
    'Video レポート',
    'Video 3PAS 関連',
    'Video その他'
  ],
  'Apps': [
    'Apps 配信関連',
    'Apps 仕様・機能',
    'Apps レポート',
    'コンバージョン',
    '除外設定・オプトアウト依頼',
    'フィードを使用したアプリキャンペーン',
    'アプリキャンペーン以外のコンバージョン (Appify)',
    'アプリユーザーへのリマーケティング',
    'Apps その他'
  ],
  'M&A': [
    'Ads CV の計測',
    'Ads CV のレポート',
    'GA4 CV の計測',
    'GA4 レポート',
    'GA4 CV と Ads CV の乖離',
    'OCI レポート乖離',
    'OCI エラー',
    '拡張コンバージョン',
    'リードの拡張コンバージョン',
    'Google タグ',
    'GTM を使用した Ads リマーケティング設定',
    'GA4 からインポートしたオーディエンス',
    'M&Aその他'
  ],
  'Other': [
    'パートナープログラム',
    'エディタ',
    '本人確認',
    'UI 操作・エラー',
    'Ads 権限付与',
    'GW・年末年始',
    'Other その他'
  ]
};

/**
 * Handle Sub Category change - update Issue Category options
 */
function handleSubCategoryChange() {
  const subCategorySelect = document.getElementById('subCategory');
  const issueCategorySelect = document.getElementById('issueCategory');

  if (!subCategorySelect || !issueCategorySelect) return;

  const subCategory = subCategorySelect.value;

  // Clear current options
  issueCategorySelect.innerHTML = '<option value="">Select Issue Category...</option>';

  // Get options for selected sub category
  const options = ISSUE_CATEGORY_MAP[subCategory];

  if (options && options.length > 0) {
    options.forEach(option => {
      const optionElement = document.createElement('option');
      optionElement.value = option;
      optionElement.textContent = option;
      issueCategorySelect.appendChild(optionElement);
    });
  }
}

/**
 * Format date for input field (YYYY-MM-DD)
 * @param {Date} date - Date object
 * @return {string}
 */
function formatDateForInput(date) {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

/**
 * Format time for input field (HH:MM:SS)
 * @param {Date} date - Date object
 * @return {string}
 */
function formatTimeForInput(date) {
  const hours = String(date.getHours()).padStart(2, '0');
  const minutes = String(date.getMinutes()).padStart(2, '0');
  const seconds = String(date.getSeconds()).padStart(2, '0');
  return `${hours}:${minutes}:${seconds}`;
}

/**
 * Add keyboard shortcuts for date/time inputs
 */
function setupKeyboardShortcuts() {
  // Add event listeners for date and time inputs
  const dateInput = document.getElementById('caseOpenDate');
  const timeInput = document.getElementById('caseOpenTime');

  if (dateInput) {
    dateInput.addEventListener('keydown', (e) => {
      // Ctrl+; sets today's date
      if (e.ctrlKey && e.key === ';') {
        e.preventDefault();
        const today = new Date();
        dateInput.value = formatDateForInput(today);
      }
    });
  }

  if (timeInput) {
    timeInput.addEventListener('keydown', (e) => {
      // Ctrl+Shift+; sets current time
      if (e.ctrlKey && e.shiftKey && e.key === ':') {
        e.preventDefault();
        const now = new Date();
        timeInput.value = formatTimeForInput(now);
      }
    });
  }
}

/**
 * Initialize cases module
 */
function initCases() {
  console.log('Cases module initialized');

  // Set up keyboard shortcuts for date/time inputs
  setupKeyboardShortcuts();
}

// Initialize when DOM is ready (only in browser environment)
if (typeof document !== 'undefined') {
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCases);
  } else {
    initCases();
  }
  console.log('Cases module loaded');
}
</script>
