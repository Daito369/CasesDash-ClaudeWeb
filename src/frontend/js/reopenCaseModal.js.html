<script>
/**
 * ReOpen Case Modal Module
 *
 * Handles reopening of closed cases through a modal dialog
 * Implements form validation, API integration, and accessibility features
 *
 * @author CasesDash v3.0.0
 */

// Global state for ReOpen Case Modal
let reopeningCaseId = null;
let reopeningSheetName = null;
let reopeningRowIndex = null;

/**
 * Open reopen case modal
 * @param {string} caseId - Case ID to reopen
 * @param {string} sheetName - Sheet name where the case is located
 * @param {number} rowIndex - Row index of the case in the sheet
 * @param {string} caseStatus - Current case status
 */
function openReopenCaseModal(caseId, sheetName, rowIndex, caseStatus) {
  console.log('Opening reopen case modal for:', caseId, 'from sheet:', sheetName, 'row:', rowIndex);

  // Verify case can be reopened
  if (caseStatus !== 'Solution Offered' && caseStatus !== 'Finished') {
    showToast(`Cannot reopen case with status: ${caseStatus}. Only Solution Offered or Finished cases can be reopened.`, 'error');
    return;
  }

  reopeningCaseId = caseId;
  reopeningSheetName = sheetName;
  reopeningRowIndex = rowIndex;

  const modal = document.getElementById('reopenCaseModal');

  // Populate case information
  document.getElementById('reopenCaseId').textContent = caseId;
  document.getElementById('reopenCurrentStatus').textContent = caseStatus;

  // Set default values - today's date and current time
  const now = new Date();

  // Format date as YYYY-MM-DD for HTML5 date input
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const day = String(now.getDate()).padStart(2, '0');
  document.getElementById('reopenDate').value = `${year}-${month}-${day}`;

  // Format time as HH:MM:SS for HTML5 time input
  const hours = String(now.getHours()).padStart(2, '0');
  const minutes = String(now.getMinutes()).padStart(2, '0');
  const seconds = String(now.getSeconds()).padStart(2, '0');
  document.getElementById('reopenTime').value = `${hours}:${minutes}:${seconds}`;

  // Show modal
  modal.style.display = 'flex';

  // Focus on first input
  document.getElementById('reopenDate').focus();
}

/**
 * Close reopen case modal
 */
function closeReopenCaseModal() {
  console.log('Closing reopen case modal');

  const modal = document.getElementById('reopenCaseModal');
  modal.style.display = 'none';

  // Clean up
  reopeningCaseId = null;
  reopeningSheetName = null;
  reopeningRowIndex = null;

  // Reset form
  document.getElementById('reopenDate').value = '';
  document.getElementById('reopenTime').value = '';
}

/**
 * Confirm reopen case
 */
async function confirmReopenCase() {
  console.log('Confirming reopen case:', reopeningCaseId);

  // Validate inputs
  const reopenDate = document.getElementById('reopenDate').value;
  const reopenTime = document.getElementById('reopenTime').value;

  if (!reopenDate) {
    showToast('Please select a ReOpen date', 'error');
    document.getElementById('reopenDate').focus();
    return;
  }

  if (!reopenTime) {
    showToast('Please select a ReOpen time', 'error');
    document.getElementById('reopenTime').focus();
    return;
  }

  // Disable button and show loading state
  const confirmBtn = document.getElementById('confirmReopenBtn');
  const originalBtnText = confirmBtn.innerHTML;
  confirmBtn.disabled = true;
  confirmBtn.innerHTML = '<span class="material-icons spinning">refresh</span> Reopening...';

  try {
    // Convert date format from YYYY-MM-DD to YYYY/MM/DD for backend
    const reopenDateFormatted = reopenDate.replace(/-/g, '/');

    // Call backend API
    const result = await API.cases.reopen(
      reopeningCaseId,
      reopenDateFormatted,
      reopenTime,
      reopeningSheetName,
      reopeningRowIndex
    );

    if (result.success) {
      showToast(`Case ${reopeningCaseId} reopened successfully`, 'success');
      closeReopenCaseModal();

      // Show ATTENTION modal
      openReopenAttentionModal();

      // Refresh the current view
      if (typeof refreshDashboard === 'function') {
        refreshDashboard();
      }
      if (typeof refreshMyCases === 'function') {
        refreshMyCases();
      }
      if (typeof closeCaseDetailsModal === 'function') {
        closeCaseDetailsModal();
      }
    } else {
      showToast(`Failed to reopen case: ${result.error || 'Unknown error'}`, 'error');
    }
  } catch (error) {
    console.error('Error reopening case:', error);
    showToast(`Error reopening case: ${error.message || 'Unknown error'}`, 'error');
  } finally {
    // Re-enable button
    confirmBtn.disabled = false;
    confirmBtn.innerHTML = originalBtnText;
  }
}

/**
 * Open ATTENTION modal after ReOpen success
 */
function openReopenAttentionModal() {
  const modal = document.getElementById('reopenAttentionModal');
  if (modal) {
    modal.style.display = 'flex';
  }
}

/**
 * Close ATTENTION modal
 */
function closeReopenAttentionModal() {
  const modal = document.getElementById('reopenAttentionModal');
  if (modal) {
    modal.style.display = 'none';
  }
}

/**
 * Handle keyboard shortcuts
 */
document.addEventListener('keydown', function(event) {
  const reopenModal = document.getElementById('reopenCaseModal');
  const attentionModal = document.getElementById('reopenAttentionModal');
  const isReopenModalOpen = reopenModal && reopenModal.style.display === 'flex';
  const isAttentionModalOpen = attentionModal && attentionModal.style.display === 'flex';

  // Escape key to close modals
  if (event.key === 'Escape') {
    if (isReopenModalOpen) {
      closeReopenCaseModal();
      return;
    }
    if (isAttentionModalOpen) {
      closeReopenAttentionModal();
      return;
    }
  }

  // Keyboard shortcuts only work when ReOpen modal is open
  if (!isReopenModalOpen) return;

  // Ctrl+; or Cmd+; → Insert current date
  if ((event.ctrlKey || event.metaKey) && event.key === ';' && !event.shiftKey) {
    event.preventDefault();
    const reopenDateInput = document.getElementById('reopenDate');
    if (reopenDateInput && document.activeElement === reopenDateInput) {
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      reopenDateInput.value = `${year}-${month}-${day}`;
    }
  }

  // Ctrl+Shift+; or Cmd+Shift+; → Insert current time
  if ((event.ctrlKey || event.metaKey) && event.key === ';' && event.shiftKey) {
    event.preventDefault();
    const reopenTimeInput = document.getElementById('reopenTime');
    if (reopenTimeInput && document.activeElement === reopenTimeInput) {
      const now = new Date();
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      const seconds = String(now.getSeconds()).padStart(2, '0');
      reopenTimeInput.value = `${hours}:${minutes}:${seconds}`;
    }
  }
});

console.log('ReOpen Case Modal module loaded');
</script>
