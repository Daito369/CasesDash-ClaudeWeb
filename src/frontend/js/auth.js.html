<script>
/**
 * Authentication Flow
 *
 * Handles login and logout operations with UI feedback.
 * Uses helper functions from api.js (showLoading, hideLoading, showError, hideError, showSuccess, handleAPIError)
 *
 * @author CasesDash v3.0.0
 */

/**
 * Handle login button click
 */
async function handleLogin() {
  console.log('Login initiated');

  // Hide previous errors
  hideError('loginError');

  // Show loading
  showLoading('loginLoading');

  // Disable login button
  const loginButton = document.getElementById('loginButton');
  if (loginButton) {
    loginButton.disabled = true;
  }

  try {
    // Call authentication API
    const result = await API.auth.authenticate();

    console.log('Authentication response:', result);

    if (result.success) {
      // Authentication successful
      console.log('Authentication successful:', result.data);

      // Show success message
      showSuccess(`Welcome, ${result.data.email}!`);

      // Reload page to show main app (only in browser)
      if (typeof window !== 'undefined') {
        setTimeout(() => {
          window.location.reload();
        }, 500);
      }

    } else {
      // Authentication failed
      const errorMessage = result.error || 'Authentication failed. Please try again.';
      showError('loginError', errorMessage);

      // Log error details
      if (result.code) {
        console.error(`Auth failed with code: ${result.code}`);
      }
      if (result.details) {
        console.error('Error details:', result.details);
      }
    }

  } catch (error) {
    // Network or script error
    const errorMessage = handleAPIError(error, 'login');
    showError('loginError', errorMessage);

  } finally {
    // Hide loading and re-enable button
    hideLoading('loginLoading');
    if (loginButton) {
      loginButton.disabled = false;
    }
  }
}

/**
 * Handle logout button click
 */
async function handleLogout() {
  console.log('Logout initiated');

  // Confirm logout
  const confirmed = confirm('Are you sure you want to logout?');
  if (!confirmed) {
    return;
  }

  // Disable logout button
  const logoutButton = document.getElementById('logoutButton');
  if (logoutButton) {
    logoutButton.disabled = true;
    logoutButton.textContent = 'Logging out...';
  }

  try {
    // Call logout API
    const result = await API.auth.logout();

    console.log('Logout response:', result);

    if (result.success) {
      // Logout successful
      console.log('Logout successful');

      // Show success message
      showSuccess('Logged out successfully');

      // Redirect to login page (only in browser)
      if (typeof window !== 'undefined') {
        setTimeout(() => {
          window.location.reload();
        }, 500);
      }

    } else {
      // Logout failed (unlikely but handle it)
      const errorMessage = result.error || 'Logout failed. Please try again.';
      alert(errorMessage);
    }

  } catch (error) {
    // Network or script error
    const errorMessage = handleAPIError(error, 'logout');
    alert(errorMessage);

  } finally {
    // Re-enable button
    if (logoutButton) {
      logoutButton.disabled = false;
      logoutButton.innerHTML = '<span class="material-icons">logout</span> Logout';
    }
  }
}

/**
 * Check authentication status on page load
 */
async function checkAuthOnLoad() {
  try {
    const status = await API.auth.checkStatus();
    console.log('Auth status on load:', status);

    if (!status.authenticated) {
      console.log('User not authenticated');
      // If on main app page but not authenticated, redirect to login (only in browser)
      if (typeof window !== 'undefined' && window.location.pathname.includes('app')) {
        window.location.href = '/';
      }
    } else {
      console.log('User authenticated:', status.user);

      // Load initial screen (Dashboard) after authentication
      const activeScreen = document.querySelector('.screen.active');
      if (activeScreen && activeScreen.id === 'dashboard-screen') {
        console.log('Loading initial Dashboard screen');
        if (typeof loadDashboardScreen === 'function') {
          loadDashboardScreen();
        }
      }
    }

  } catch (error) {
    console.error('Error checking auth status:', error);
  }
}

/**
 * Set up periodic session refresh (every 30 minutes)
 */
function setupSessionRefresh() {
  // Refresh session every 30 minutes
  setInterval(async () => {
    try {
      console.log('Refreshing session...');
      const result = await API.auth.refresh();

      if (result.success) {
        console.log('Session refreshed successfully');
      } else {
        console.warn('Session refresh failed:', result.error);
      }

    } catch (error) {
      console.error('Error refreshing session:', error);
    }
  }, 30 * 60 * 1000); // 30 minutes
}

/**
 * Show screen by name
 * @param {string} screenName - Screen name (e.g., 'dashboard', 'myCases', 'createCase', 'settings')
 */
function showScreen(screenName) {
  console.log(`Navigating to ${screenName} screen`);

  // Stop timers if leaving My Cases or All Cases screen
  const currentScreen = document.querySelector('.screen.active');
  if (currentScreen && currentScreen.id === 'myCases-screen') {
    if (typeof stopMyCasesTimers === 'function') {
      stopMyCasesTimers();
    }
  }
  if (currentScreen && currentScreen.id === 'allCases-screen') {
    if (typeof stopAllCasesTimers === 'function') {
      stopAllCasesTimers();
    }
  }

  // Hide all screens
  const screens = document.querySelectorAll('.screen');
  screens.forEach(screen => {
    screen.classList.remove('active');
    screen.style.display = 'none';
  });

  // Remove active class from all nav buttons
  const navButtons = document.querySelectorAll('.nav-link');
  navButtons.forEach(btn => btn.classList.remove('active'));

  // Show selected screen
  const screenId = `${screenName}-screen`;
  const screenElement = document.getElementById(screenId);

  if (screenElement) {
    screenElement.style.display = 'block';
    screenElement.classList.add('active');

    // Activate corresponding nav button
    const navButton = document.getElementById(`nav${screenName.charAt(0).toUpperCase() + screenName.slice(1)}`);
    if (navButton) {
      navButton.classList.add('active');
    }

    // Load screen-specific content
    switch (screenName) {
      case 'myCases':
        if (typeof loadMyCasesScreen === 'function') {
          loadMyCasesScreen();
        }
        break;
      case 'allCases':
        if (typeof loadAllCasesScreen === 'function') {
          loadAllCasesScreen();
        }
        break;
      case 'createCase':
        if (typeof loadCreateCaseScreen === 'function') {
          loadCreateCaseScreen();
        }
        break;
      case 'settings':
        if (typeof loadSettingsScreen === 'function') {
          loadSettingsScreen();
        }
        break;
      case 'dashboard':
        if (typeof loadDashboardScreen === 'function') {
          loadDashboardScreen();
        }
        break;
      default:
        console.warn(`Unknown screen: ${screenName}`);
    }
  } else {
    console.error(`Screen not found: ${screenId}`);
  }
}

/**
 * Initialize authentication module
 */
function initAuth() {
  console.log('Auth module initialized');

  // Check auth status on load
  checkAuthOnLoad();

  // Set up session refresh
  setupSessionRefresh();

  // Add keyboard shortcuts (only in browser environment)
  if (typeof document !== 'undefined') {
    document.addEventListener('keydown', (e) => {
      // Ctrl/Cmd + Enter on login page triggers login
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        const loginButton = document.getElementById('loginButton');
        if (loginButton && !loginButton.disabled) {
          handleLogin();
        }
      }
    });
  }
}

// Initialize when DOM is ready (only in browser environment)
if (typeof document !== 'undefined') {
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initAuth);
  } else {
    initAuth();
  }
  console.log('Auth module loaded');
}
</script>
