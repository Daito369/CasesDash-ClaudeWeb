# Email Notification System - セットアップガイド（日本語版）

**バージョン**: 3.0.0
**最終更新**: 2025-11-11
**仕様書**: Section 7 - Gmail通知システム

---

## 📋 概要

Email Notification System は、ケースの IRT（Internal Resolution Time）タイマーが2時間を下回った際に、チームリーダーへ自動的に Gmail アラートを送信します。これにより、SLA 違反を防ぎ、タイムリーなケース解決を保証します。

### 主な機能

- ✅ **自動 IRT 監視**: 毎時すべてのケースをチェック
- ✅ **スマートアラート**: "Assigned" ステータスで IRT ≤ 2時間のケースのみ通知
- ✅ **重複防止**: 6時間以内に複数のアラートを送信しない
- ✅ **HTML メール**: プロフェッショナルなブランド付きメール通知
- ✅ **ログ記録**: すべての通知を "Notification Log" シートに記録
- ✅ **設定可能**: チーム構成と設定をスプレッドシートで管理

---

## 🚀 クイックスタート（5ステップ）

### ステップ 1: Script Properties を設定

Google Apps Script エディタを開いて → プロジェクト設定 → スクリプト プロパティ、以下を追加：

| プロパティ名 | 値の例 | 説明 |
|------------|--------|------|
| `DEFAULT_TL_EMAIL` | `teamlead@google.com` | TL が見つからない場合のフォールバック先 |
| `APP_URL` | `https://script.google.com/...` | CasesDash ウェブアプリの URL |

**追加方法:**
1. 「スクリプト プロパティを追加」をクリック
2. プロパティ名を入力
3. 値を入力
4. 「スクリプト プロパティを保存」をクリック

### ステップ 2: チーム構成を設定（推奨）

Google スプレッドシートの **Configuration** シートにチームマッピングを作成：

| A列: Assignee LDAP | B列: Team Leader Email |
|-------------------|------------------------|
| jsmith | tl-jsmith@google.com |
| mjohnson | tl-mjohnson@google.com |
| alee | tl-alee@google.com |

**フォーマット:**
- A列: 担当者の LDAP（@google.com あり/なし どちらでもOK）
- B列: チームリーダーの完全なメールアドレス

担当者がこのマッピングに見つからない場合、システムは `DEFAULT_TL_EMAIL` を使用します。

### ステップ 3: IRT RAW data シートに「Last Notified」列を追加

**IRT RAW data** シートを開き、**O列**（15列目）が存在することを確認：

| 列 | ヘッダー | 用途 |
|----|---------|------|
| O | Last Notified | 最後に通知を送信した日時 |

存在しない場合は、列を挿入し、1行目の O列に "Last Notified" ヘッダーを追加してください。

### ステップ 4: 時間ベーストリガーを設定

1. Google Apps Script エディタを開く
2. 左サイドバーの**トリガー**（時計アイコン）をクリック
3. 右下の **「+ トリガーを追加」** をクリック
4. 以下のように設定：
   - **実行する関数を選択**: `checkAndSendIRTAlerts`
   - **イベントのソースを選択**: `時間主導型`
   - **時間ベースのトリガーのタイプを選択**: `時間ベースのタイマー`
   - **時間の間隔を選択（時間）**: `1時間おき`
5. **「保存」** をクリック

**推奨スケジュール:**
- **本番環境**: 1時間おき（レスポンスとクォータ使用量のバランス）
- **開発/テスト**: 6時間おき（初期テスト用）

### ステップ 5: システムをテスト

テスト関数を実行してメール配信を確認：

1. Google Apps Script エディタを開く
2. `NotificationService.gs` を開く
3. 最下部の `testSendIRTAlert()` 関数を見つける
4. `'your-test-email@google.com'` を実際の @google.com メールアドレスに置き換える
5. **実行** → `testSendIRTAlert` を選択
6. プロンプトが表示されたらスクリプトを認証
7. Gmail 受信トレイで IRT アラートを確認

**期待される結果:**
- ✅ 件名「IRT Alert」のメールを受信
- ✅ HTML フォーマットが正しく表示される
- ✅ ログエントリ付きで「Notification Log」シートが作成される

---

## 📊 仕組み

### ワークフロー

```
┌─────────────────────────────────────────────────────────┐
│  時間ベーストリガー（毎時）                                │
└───────────────────┬─────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────┐
│  checkAndSendIRTAlerts()                                 │
│  - IRT RAW data シートを読み取り                          │
│  - すべてのケースをチェック                                │
└───────────────────┬─────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────┐
│  各ケースについて:                                         │
│  1. Status = "Assigned" をチェック                       │
│  2. IRT Remaining ≤ 2時間 をチェック                     │
│  3. 最近通知されていない（6時間以内でない）をチェック         │
└───────────────────┬─────────────────────────────────────┘
                    │
                    ▼ （すべての条件を満たす場合）
┌─────────────────────────────────────────────────────────┐
│  ケース詳細とチームリーダーメールを取得                       │
└───────────────────┬─────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────┐
│  sendIRTAlertEmail()                                     │
│  - GmailApp 経由で HTML メールを送信                      │
│  - "Notification Log" シートにログ記録                    │
│  - "Last Notified" タイムスタンプを更新                   │
└─────────────────────────────────────────────────────────┘
```

### アラート条件

アラートは、**すべて**の条件が満たされた場合のみ送信されます：

1. ✅ **Case Status** = `"Assigned"`
2. ✅ **IRT Remaining** ≤ 2時間 かつ > 0時間
3. ✅ **最近通知されていない**（最後の通知が6時間以上前）

**アラートが送信されないケース:**
- ❌ Status = "Solution Offered" または "Finished"
- ❌ IRT Remaining > 2時間（まだ安全）
- ❌ IRT Remaining ≤ 0時間（既に SLA ミス）
- ❌ 6時間以内に通知済み（スパム防止）

---

## 🔧 設定オプション

### Script Properties

| プロパティ | タイプ | デフォルト | 説明 |
|-----------|--------|-----------|------|
| `DEFAULT_TL_EMAIL` | string | （必須） | フォールバックのチームリーダーメール |
| `APP_URL` | string | （オプション） | メールリンク用の CasesDash ウェブアプリ URL |

### チーム構成シート

**場所**: Configuration シートまたは Settings シート
**フォーマット**:

```
| A: Assignee LDAP | B: Team Leader Email | C: Team Name (オプション) |
|------------------|----------------------|---------------------------|
| jsmith          | tl-alpha@google.com   | Team Alpha                |
| mjohnson        | tl-beta@google.com    | Team Beta                 |
```

### Notification Log シート

**自動作成**: はい（初回通知時に自動作成）
**列構成**:

| 列 | ヘッダー | タイプ | 説明 |
|----|---------|--------|------|
| A | Timestamp | DateTime | 通知送信日時 |
| B | Case ID | String | アラートをトリガーしたケース ID |
| C | Recipient | String | チームリーダーのメールアドレス |
| D | Type | String | 通知タイプ（IRT_ALERT_2H） |
| E | Status | String | SUCCESS または FAILED |
| F | Error | String | 失敗時のエラーメッセージ |

---

## 🧪 テスト

### 手動テスト（本番前）

1. **メール送信テスト**:
   ```javascript
   // NotificationService.gs 内
   function testSendIRTAlert() {
     // ... （テストメールを変更）
   }
   ```
   この関数を実行してメール配信を確認。

2. **チームリーダー検索テスト**:
   ```javascript
   function testGetTeamLeader() {
     const tlEmail = getTeamLeaderEmail('testuser');
     Logger.log('Team Leader Email: ' + tlEmail);
   }
   ```

3. **checkAndSendIRTAlerts() テスト（ドライラン）**:
   - `checkAndSendIRTAlerts()` を手動で実行
   - 実行ログで結果を確認
   - "Notification Log" シートのエントリを確認

### 本番環境の監視

**トリガー実行の確認**:
1. GAS エディタの**トリガー**に移動
2. トリガーをクリック → **実行数**を表示
3. エラーや失敗を監視

**Notification Logs の確認**:
- "Notification Log" シートを開く
- SUCCESS/FAILED ステータスの最新エントリを確認
- FAILED 通知を調査

**実行ログの表示**:
1. GAS エディタ → **実行数**（左サイドバー）
2. `checkAndSendIRTAlerts` でフィルタ
3. 各実行のログを確認

---

## 🚨 トラブルシューティング

### 問題 1: メールが送信されない

**症状**: トリガーは実行されるがメールが届かない

**原因と解決策**:

1. **アラート条件を満たすケースがない**
   - 確認: Status="Assigned" かつ IRT ≤ 2時間のケースはあるか？
   - 解決策: テスト用に低 IRT のケースを作成

2. **Script Properties が未設定**
   - 確認: Script Properties に `DEFAULT_TL_EMAIL` が設定されているか？
   - 解決策: 必要なプロパティを追加

3. **チームリーダーメールが見つからない**
   - 確認: 実行ログに "using default TL email" メッセージがあるか
   - 解決策: Configuration シートに assignee → TL マッピングを追加

4. **ケースが最近通知済み**
   - 確認: IRT RAW data の "Last Notified" 列
   - 解決策: 6時間待つか、テスト用にタイムスタンプを手動でクリア

### 問題 2: メール配信失敗

**症状**: Notification Log に "FAILED" ステータス

**原因と解決策**:

1. **無効なメールアドレス**
   - 確認: 実行ログでエラーメッセージを確認
   - 解決策: Configuration シートのチームリーダーメール形式を確認

2. **Gmail クォータ超過**
   - 確認: GAS クォータダッシュボード
   - 解決策: トリガー頻度を減らすか、Google サポートに連絡

3. **認証の問題**
   - 確認: スクリプトの認証ステータス
   - 解決策: 必要な Gmail 権限でスクリプトを再認証

### 問題 3: 間違ったチームリーダーにアラートが送信される

**症状**: 間違ったチームリーダーにメールが送信される

**原因と解決策**:

1. **チームマッピングが不正確**
   - 確認: Configuration シートのマッピング
   - 解決策: assignee → TL マッピングを更新

2. **LDAP フォーマットの不一致**
   - 確認: シート内の Assignee LDAP 形式（@google.com あり/なし）
   - 解決策: 一貫した形式を確保（システムは両方に対応）

### 問題 4: 重複アラート

**症状**: 6時間以内に同じケースで複数のアラートがトリガーされる

**原因と解決策**:

1. **"Last Notified" が更新されない**
   - 確認: IRT RAW data シート O列の値
   - 解決策: O列が存在し、書き込み可能であることを確認

2. **複数のトリガーが実行されている**
   - 確認: トリガーページで重複トリガーを確認
   - 解決策: 重複トリガーを削除、1つだけ保持

---

## 📈 パフォーマンスとクォータ

### Gmail クォータ（Google Apps Script）

| クォータタイプ | 無料アカウント | Google Workspace |
|--------------|---------------|------------------|
| 1日あたりのメール数 | 100 | 1,500 |
| メールあたりの受信者数 | 50 | 複数 |

**現在の使用状況**:
- ケースごとにアラート1通
- 1時間ごとに1回のトリガー実行 = 最大24回/日
- 実行ごとに10ケースがアラート = 240通/日（クォータ内）

**最適化のヒント**:
- トリガーを2時間おきに設定（実行回数を50%削減）
- 6時間の重複防止を設定（既に実装済み）
- 1日のメール数を "Notification Log" シートで監視

### 実行時間

**平均実行時間**: 5〜15秒
- IRT RAW data シート内のケース数に依存
- 100ケース ≈ 5秒
- 1,000ケース ≈ 15秒

---

## 🔐 セキュリティとプライバシー

### メールセキュリティ

- ✅ GmailApp を使用（認証された Google アカウントから送信）
- ✅ メールは "送信済み" フォルダに保存（監査証跡）
- ✅ HTML サニタイゼーション（テンプレートにユーザー入力なし）
- ✅ ドメイン制限（@google.com のみ）

### データプライバシー

- ⚠️ メールにはケース詳細が含まれる（Case ID、Assignee、Segment、Product）
- ⚠️ チームリーダーが適切なアクセス権限を持っていることを確認
- ⚠️ Notification Log には受信者メールアドレスが含まれる

**ベストプラクティス**:
- 承認されたチームリーダーにのみ送信
- Configuration シートのチームマッピングを定期的に確認
- "Notification Log" シートを定期的に監査

---

## 📝 メンテナンス

### 週次タスク

- [ ] "Notification Log" で失敗した通知を確認
- [ ] トリガー実行履歴でエラーを確認
- [ ] チームリーダーマッピングが最新であることを確認

### 月次タスク

- [ ] 古い "Notification Log" エントリをアーカイブ（過去3ヶ月を保持）
- [ ] メールクォータ使用状況を確認
- [ ] サンプルケースでエンドツーエンドフローをテスト

### 四半期タスク

- [ ] チーム構成マッピングを更新
- [ ] トリガー頻度を確認・最適化
- [ ] 通知配信成功率を監査

---

## 📞 サポート

### よくある質問

**Q: 2時間の閾値を変更できますか？**
A: はい、`shouldSendAlert()` 関数内の `irtRemainingHours <= 2` を変更してください。

**Q: 複数のチームリーダーに送信できますか？**
A: `sendIRTAlertEmail()` を変更してメールの配列を受け取り、ループで送信してください。

**Q: メールテンプレートをカスタマイズできますか？**
A: はい、`sendIRTAlertEmail()` 関数内の HTML を編集してください。

**Q: 通知を一時的に無効にするには？**
A: トリガーページでトリガーを無効化または削除してください。

### ヘルプの取得

1. GAS エディタで実行ログを確認
2. "Notification Log" シートでエラーメッセージを確認
3. 開発ガイドライン CLAUDE.md を参照
4. システム管理者に連絡

---

## 🎉 成功チェックリスト

本番環境に移行する前に、以下を確認：

- [x] Script Properties が設定済み（`DEFAULT_TL_EMAIL`、`APP_URL`）
- [x] Configuration シートにチーム構成がマッピング済み
- [x] IRT RAW data に "Last Notified" 列が存在（O列）
- [x] 時間ベーストリガーが作成され、アクティブ
- [x] `testSendIRTAlert()` 経由でテストメールが正常に送信された
- [x] `checkAndSendIRTAlerts()` の手動実行がエラーなく完了
- [x] "Notification Log" シートがログエントリ付きで作成された
- [x] チームリーダーがアラートメールを受信し、読める
- [x] 実行ログに認証エラーがない

---

**システムステータス**: ✅ 本番環境準備完了

技術実装の詳細については、以下を参照してください：
- **仕様書**: docs/casesdash-specification.md Section 7
- **開発者ガイド**: docs/CLAUDE.md
- **ソースコード**: src/backend/services/NotificationService.gs
